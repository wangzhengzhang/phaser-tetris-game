<!DOCTYPE html>
<html>
  <head>
    <title>俄罗斯方块</title>
    <style>
      /* 基础样式重置 */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: Arial, Helvetica, sans-serif;
      }

      h1 {
        color: #333;
        margin: 20px 0;
        font-size: 24px;
      }

      h2 {
        color: #444;
        margin: 15px 0;
        font-size: 20px;
      }

      /* 进度条覆盖层 */
      .progress-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 0.5s ease;
      }

      /* 进度条容器 */
      .progress-container {
        width: 80%;
        max-width: 600px;
        height: 8px;
        background: #eee;
        border-radius: 4px;
        overflow: hidden;
        margin: 20px 0;
        border: 1px solid #ddd;
      }

      /* 进度条 */
      .progress-bar {
        height: 100%;
        background: #4285f4;
        width: 0%;
        transition: width 0.3s ease;
      }

      /* 资源列表样式 */
      .resource-list {
        max-height: 600px;
        overflow-y: auto;
        width: 80%;
        max-width: 600px;
        margin-top: 20px;
        font-size: 14px;
        border: 1px solid #eee;
        padding: 10px;
        border-radius: 4px;
      }

      .resource-item {
        padding: 5px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .resource-item:last-child {
        border-bottom: none;
      }

      /* 状态图标使用CSS绘制 */
      .icon {
        display: inline-block;
        width: 16px;
        height: 16px;
        margin-right: 8px;
        vertical-align: middle;
      }

      .icon-loading {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #4285f4;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .icon-success {
        position: relative;
        color: #4caf50;
      }

      .icon-success::after {
        content: "✓";
        position: absolute;
        top: -2px;
      }

      .icon-error {
        position: relative;
        color: #f44336;
      }

      .icon-error::after {
        content: "✗";
        position: absolute;
        top: -2px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* 页面内容样式 */
      #mainContent {
        display: none;
        width: 100%;
        height: 100%;
      }

      #mainContent p {
        color: #666;
        line-height: 1.6;
      }
      html {
        width: 100%; /* 宽度占满视口 */
        height: 100%; /* 高度占满视口 */
        margin: 0; /* 清除默认边距（部分浏览器可能有） */
        padding: 0; /* 清除默认内边距 */
      }

      body {
        width: 100%; /* 宽度 = html 的宽度（即视口宽度） */
        height: 100%; /* 高度 = html 的高度（即视口高度） */
        margin: 0; /* 关键！清除浏览器默认的 body 边距（通常是 8px） */
        padding: 0; /* 清除默认内边距（可选，根据需求） */
        background: #f0f0f0; /* 加背景色方便观察效果 */
      }
    </style>
  </head>
  <body>
    <!-- 进度条覆盖层 -->
    <div class="progress-overlay" id="progressOverlay">
      <h2>加载中... <span id="progressPercent">0%</span></h2>
      <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="resource-list" id="resourceList"></div>
    </div>
    <div id="mainContent">
      <h1>页面加载完成</h1>
      <p>所有资源已加载完毕，可以正常使用了。</p>
    </div>
    <div id="mainHiddenContent">

    </div>
        <script>
          async function appendHtml(url) {
            const response = await fetch(url);
            if (!response.ok) throw new Error("加载失败");
            const html = await response.text();
            document.getElementById("mainHiddenContent").innerHTML += html;
            return true;
          }

      // 加载并插入外部HTML
      async function includeHTML(url, containerId) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("加载失败");

          const html = await response.text();
          document.getElementById(containerId).innerHTML = html;

          // 可选：如果加载的HTML中包含脚本，需要手动执行
          executeScripts(document.getElementById(containerId));
        } catch (error) {
          console.error("加载HTML出错:", error);
        }
      }

      // 执行动态加载的脚本
      function executeScripts(container) {
        const scripts = container.querySelectorAll("script");
        scripts.forEach((oldScript) => {
          const newScript = document.createElement("script");
          // 复制所有属性
          Array.from(oldScript.attributes).forEach((attr) => {
            newScript.setAttribute(attr.name, attr.value);
          });
          newScript.textContent = oldScript.textContent;
          oldScript.parentNode.replaceChild(newScript, oldScript);
        });
      }

      // 加载并包含header.html到页面中
      includeHTML("main.html", "mainContent");
    </script>


    <script>
      resourceStatus = {};
      let loadedResources = 0;
      function resourceLoaded(ele) {
        loadedResources++;
        // var key = "";
        // if(ele)
        if (ele.tagName == "SCRIPT") resourceStatus[ele.src] = true;
        else if (ele.tagName == "LINK") resourceStatus[ele.href] = true;
        else if (ele.tagName == "IMG") resourceStatus[ele.src] = true;

        console.log("resourceLoaded: ", ele);
        if (typeof updateProgressForItem == "function")
          updateProgressForItem(ele.src, true);
        else console.log("updateProgressForItem is not a function");
      }
      function resourceError(ele, index) {
        if (ele.tagName == "SCRIPT") resourceStatus[ele.src] = false;
        else if (ele.tagName == "LINK") resourceStatus[ele.href] = false;
        else if (ele.tagName == "IMG") resourceStatus[ele.src] = false;

        console.log("resourceError: ", ele);
        if (typeof updateProgressForItem == "function")
          updateProgressForItem(ele.src, true);
        else console.log("updateProgressForItem is not a function");
      }
    </script>

    <!-- main content 页面内容 -->
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" defer
      onload="resourceLoaded(this);"
      onerror="resourceError(this)"
      rel="stylesheet"
    />
    <script
      src="https://cdn.tailwindcss.com" defer
      onload="resourceLoaded(this);"
      onerror="resourceError(this)"
    ></script>
    <script src="./tailwind-config.js" defer
      onload="resourceLoaded(this);"
      onerror="resourceError(this)"
    ></script>
    <script
      src="./phaser.min.js" defer
      onload="resourceLoaded(this);"
      onerror="resourceError(this)"
    ></script>

    <!-- main content 中需要加载的 js, css, img 资源-->
    <link
      href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"  defer
      onload="resourceLoaded(this);"
      onerror="resourceError(this)"
      rel="stylesheet"
    />

    <script
      src="./main.js" defer
      onload="resourceLoaded(this);"
      onerror="resourceError(this)"
    ></script>

    <script
      src="./storage_manager.js" defer
      onload="resourceLoaded(this);"
      onerror="resourceError(this)"
    ></script>

    

    <script
      src="./dialog.js" defer
      onload="resourceLoaded(this);"
      onerror="resourceError(this)"
    ></script>

    <script
      src="./game.js" defer
      onload="resourceLoaded(this);"
      onerror="resourceError(this)"
    ></script>



    <script>
      // 1. 获取需要监控的资源
      function getResourcesToMonitor() {
        var resourceId = 0; // 资源ID
        const resources = [];
        // 监控脚本
        document.querySelectorAll("script[src]").forEach((script) => {
          resources.push({ type: "script", url: script.src, ele: script });
        });
        // 监控图片
        document.querySelectorAll("img").forEach((img) => {
          if (img.src) {
            resources.push({ type: "img", url: img.src, ele: img });
          }
        });

        // 监控样式表（修复forEach问题）
        Array.from(document.styleSheets).forEach((styleSheet) => {
          try {
            if (styleSheet.href) {
              resources.push({
                type: "css",
                url: styleSheet.href,
                ele: styleSheet,
              });
              styleSheet.resourceId = resourceId;
              resourceId++;
            }
          } catch (e) {
            // 跨域样式表可能无法访问，忽略
          }
        });

        return resources;
      }

      // 2. 初始化监控
      const resources = getResourcesToMonitor();
      const totalResources = resources.length;

      const progressBar = document.getElementById("progressBar");
      const progressPercent = document.getElementById("progressPercent");
      const resourceList = document.getElementById("resourceList");
      const progressOverlay = document.getElementById("progressOverlay");
      const mainContent = document.getElementById("mainContent");

      // 3. 更新进度
      function updateProgress() {
        const progress =
          totalResources > 0
            ? Math.round((loadedResources / totalResources) * 100)
            : 100;

        progressBar.style.width = `${progress}%`;
        progressPercent.textContent = `${progress}%`;

        // 所有资源加载完成
        if (progress === 100) {
          setTimeout(() => {
            progressOverlay.style.opacity = 0;
            setTimeout(() => {
              progressOverlay.style.display = "none";
              mainContent.style.display = "block";
            }, 10);
          }, 500);
        }
      }

      function updateProgressForItem(key, status = "") {
        Array.from(resourceList.children).forEach((item) => {
          if (item.key === key) {
            var status = resourceStatus[item.key];
            var names = item.key.replace(/\/+$/, "").split("/"); // 替换掉末尾的 / (如果存在)
            var name = names.pop();
            //if(!name)name = names.pop();

            if (status === true) {
              // 加载成功
              item.innerHTML = `
                <span class="icon icon-success"></span>
                <span>${name}</span>
              `;
            } else if (status === false) {
              // 加载失败
              item.innerHTML = `
                <span class="icon icon-error"></span>
                <span>${name}(加载失败)</span>
              `;
            } else {
              // 加载中
              item.innerHTML = `
                <span class="icon icon-loading"></span>
                <span>${name}</span>
              `;
            }
          }
        });

        updateProgress();
      }

      // 4. 监控每个资源的加载状态
      function monitorResource(resource) {
        // 创建资源项显示
        const listItem = document.createElement("div");
        listItem.className = "resource-item";
        listItem.key = resource.url;
        resourceList.appendChild(listItem);
        updateProgressForItem(resource.url); // 未知状态
      }

      // 5. 开始监控所有资源
      resources.forEach(monitorResource);

      // 6. 处理window.onload（所有资源加载完成的最终确认）
      window.onload = function () {
        // 确保进度条最终达到100%
        loadedResources = totalResources;
        updateProgress();
        console.log("所有资源加载完成（window.onload触发）");
      };

      // 初始进度更新
      updateProgress();
    </script>
  </body>
</html>
